# syntax=docker/dockerfile:1.7
FROM golang:1.24-bookworm AS build
WORKDIR /src
COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod go mod download
COPY . .
RUN --mount=type=cache,target=/go/pkg/mod --mount=type=cache,target=/root/.cache/go-build CGO_ENABLED=0 go build -trimpath -o /out/openai-stub ./cmd/openai-stub

FROM debian:bookworm-slim
RUN set -eux; \
    apt-get update; \
    apt-get install -y --no-install-recommends ca-certificates curl; \
    rm -rf /var/lib/apt/lists/*; \
    useradd -m -u 10001 appuser
USER appuser
COPY --from=build /out/openai-stub /usr/local/bin/openai-stub
ENV ADDR=:8081 MODEL_ID=test-model
EXPOSE 8081
ENTRYPOINT ["/usr/local/bin/openai-stub"]
