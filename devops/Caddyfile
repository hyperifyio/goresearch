# Caddyfile for local HTTPS termination to llm and searxng services
# This provides optional TLS termination with self-signed certificates for local development
# The TLS profile must be explicitly enabled to use this service.

# SearxNG service proxy with self-signed cert
:8444 {
	# Enable self-signed TLS for local development
	tls internal

	# Reverse proxy to the SearxNG service
	reverse_proxy searxng:8080 {
		# Add health check to upstream
		health_uri /status
		health_interval 10s
		health_timeout 5s
	}

	# Security headers for local dev
	header {
		# Prevent HTTPS downgrade attacks (even for local certs)
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		# Prevent clickjacking
		X-Frame-Options "DENY"
		# Prevent MIME sniffing
		X-Content-Type-Options "nosniff"
		# Remove server identification
		-Server
	}

	# Logging for debugging
	log {
		output stdout
		format console
	}
}

# Global configuration
{
	# Disable automatic HTTPS redirects for our controlled local environment
	auto_https off
	
	# Use internal CA for self-signed certificates
	# This creates a local CA that's consistent across restarts
	local_certs
}